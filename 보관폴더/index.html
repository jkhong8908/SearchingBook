<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>도서 구매와 대여 정보를 한눈에</title>
  <style>
    /* 기존 스타일 유지 */
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    #searchInput {
      width: 400px;
      padding: 10px;
      font-size: 16px;
    }
    #searchButton {
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
    }
    .results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    .book-card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .book-card img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 8px;
    }
    .book-info {
      margin-top: 10px;
    }
    .book-info h3 {
      margin: 5px 0;
    }
    .price {
      margin-top: 5px;
      font-weight: bold;
      color: #1a73e8;
    }
    .links a {
      display: inline-block;
      margin-top: 5px;
      color: #555;
      text-decoration: underline;
      font-size: 14px;
      cursor: pointer;
    }
    .dropdown-container {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      display: none;
      flex-direction: row;
      gap: 10px;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      align-items: center;
    }
    .dropdown-container select {
      padding: 6px;
      font-size: 14px;
      min-width: 150px;
    }
    .dropdown-container #checkLibraryBtn,
    .dropdown-container #closeDropdownBtn {
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
      background-color: #1a73e8;
      border: none;
      color: white;
      border-radius: 4px;
      white-space: nowrap;
    }
    .dropdown-container #checkLibraryBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #loadMoreBtn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      user-select: none;
    }
    #loadMoreBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    select option {
      color: black !important;
      font-size: 16px;
      opacity: 1 !important;
      background-color: white;
    }
    select:disabled {
      background-color: #f0f0f0;
    }

    /* ✅ 모달 스타일 추가 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;      
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: absolute;
      top: 25%;
      left: 20%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover {
      color: black;
    }
  </style>
</head>
<body>
  <h1>📚 도서 구매와 대여 정보를 한눈에</h1>

  <div class="search-container">
    <input id="searchInput" type="text" placeholder="책 제목, 작가, 출판사 입력" />
    <button id="searchButton">검색</button>
  </div>

  <div class="dropdown-container">
    <select id="regionSelect"><option value="">--지역 선택--</option></select>
    <select id="districtSelect" disabled><option value="">--시군구 선택--</option></select>
    <select id="librarySelect" disabled><option value="">--도서관 선택--</option></select>
    <button id="checkLibraryBtn" disabled>확인</button>
    <button id="closeDropdownBtn">닫기</button>
  </div>

  <div class="results" id="results"></div>
  <button id="loadMoreBtn" style="display:none;">더보기</button>

  <!-- ✅ 모달 구조 추가 -->
  <div id="libraryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="closeModalBtn">&times;</span>
      <div><strong>[책 제목]</strong> <span id="modalBookTitle"></span></div>
      <div id="libraryModalContent">로딩 중...</div>
    </div>
  </div>

  <script>
    document.getElementById('searchButton').addEventListener('click', searchBooks);
    document.getElementById('searchInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchBooks();
      }
    });

    const resultsContainer = document.getElementById('results');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const dropdownContainer = document.querySelector('.dropdown-container');
    const dropdownRegionSelect = document.getElementById('regionSelect');
    const dropdownDistrictSelect = document.getElementById('districtSelect');
    const dropdownLibrarySelect = document.getElementById('librarySelect');
    const checkLibraryBtn = document.getElementById('checkLibraryBtn');
    const closeDropdownBtn = document.getElementById('closeDropdownBtn');
    const modal = document.getElementById('libraryModal');
    const modalContent = document.getElementById('libraryModalContent');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let libraryData = {};
    let selectedISBN = null;
    let selectedTitle = null;
    let selectedDistrict = null;  // [추가] 시군구명 저장용
    let allBooks = [];
    let displayedCount = 0;
    const PAGE_SIZE = 12;

    function formatPrice(num) {
      return Number(num).toLocaleString() + '원';
    }

    function createBookCard(book) {
      const priceNew = book.priceStandard ? formatPrice(book.priceStandard) : '정보 없음';
      const priceSale = book.priceSales ? formatPrice(book.priceSales) : '정보 없음';
      const usedLink = `https://www.aladin.co.kr/search/wsearchresult.aspx?SearchTarget=Used&KeyWord=${encodeURIComponent(book.title)}`;

      const card = document.createElement('div');
      card.className = 'book-card';

      card.innerHTML = `
        <img src="${book.cover}" alt="표지 이미지">
        <div class="book-info">
          <h3>${book.title}</h3>
          <p>저자: ${book.author}</p>
          <p>출판사: ${book.publisher} (${book.pubDate})</p>
          <p class="price">정가: ${priceNew} / 할인가: ${priceSale}</p>
          <div class="links">
            <a href="${book.link}" target="_blank">🔗 새책/ 전자책 사러가기</a><br>
            <a href="${usedLink}" target="_blank">📚 중고책 사러가기</a><br><br>
            <a href="#" class="library-status-link" 
               data-isbn="${book.isbn13}" 
               data-title="${book.title}"
               style="font-size: 16px; color: #000000; font-weight: bold;">
              📖 관심도서관 대여현황 확인
            </a>
          </div>
        </div>
      `;
      return card;
    }

    function renderBooks() {
      const toShow = allBooks.slice(displayedCount, displayedCount + PAGE_SIZE);
      toShow.forEach(book => {
        resultsContainer.appendChild(createBookCard(book));
      });
      displayedCount += toShow.length;

      if (displayedCount < allBooks.length) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.disabled = false;
      } else {
        loadMoreBtn.style.display = 'none';
      }

      document.querySelectorAll('.library-status-link').forEach(link => {
        link.removeEventListener('click', onLibraryStatusClick);
        link.addEventListener('click', onLibraryStatusClick);
      });
    }

    function onLibraryStatusClick(e) {
      e.preventDefault();
      selectedISBN = e.target.dataset.isbn;
      selectedTitle = e.target.dataset.title;
      console.log('선택된 ISBN:', selectedISBN);
      console.log('선택된 도서명:', selectedTitle);
      dropdownContainer.style.display = 'flex';
    }

    function searchBooks() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return alert('검색어를 입력하세요.');

      dropdownContainer.style.display = 'none';
      selectedISBN = null;
      resultsContainer.innerHTML = '';
      loadMoreBtn.style.display = 'none';
      displayedCount = 0;
      allBooks = [];

      fetch(`/search?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.item || data.item.length === 0) {
            resultsContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
          }
          allBooks = data.item;
          renderBooks();
        });
    }

    loadMoreBtn.addEventListener('click', renderBooks);

    fetch('/libraries')
      .then(res => res.json())
      .then(data => {
        libraryData = data;
        data.regions.forEach(region => {
          const opt = document.createElement('option');
          opt.value = region;
          opt.textContent = region;
          dropdownRegionSelect.appendChild(opt);
        });
      });

    dropdownRegionSelect.addEventListener('change', () => {
      const region = dropdownRegionSelect.value;      
      
      dropdownDistrictSelect.innerHTML = '<option value="">--시군구 선택--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--도서관 선택--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = null;  

      if (!region || !libraryData.districtsByRegion[region]) return;
      
      libraryData.districtsByRegion[region].forEach(district => {
        const opt = document.createElement('option');
        opt.value = district;
        opt.textContent = district;
        dropdownDistrictSelect.appendChild(opt);
      });

      dropdownDistrictSelect.disabled = false;
    });

        
    dropdownDistrictSelect.addEventListener('change', () => {
      const district = dropdownDistrictSelect.value;
      const region = dropdownRegionSelect.value;

      dropdownLibrarySelect.innerHTML = '<option value="">--도서관 선택--</option>';
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = district;  // [추가] 시군구 선택 저장

      const key = `${region.trim()}|${district.trim()}`;
      if (!district || !libraryData.librariesByDistrict[key]) return;

      updateLibrarySelect(district);
    });

    dropdownLibrarySelect.addEventListener('change', () => {
      checkLibraryBtn.disabled = !dropdownLibrarySelect.value;
    });

    checkLibraryBtn.addEventListener('click', () => {
      const libCode = dropdownLibrarySelect.value;
      console.log('확인 버튼 클릭 - 선택된 ISBN:', selectedISBN);
      console.log('선택된 도서관 코드:', libCode);

      if (!selectedISBN || !libCode) {
        console.log('ISBN 또는 도서관 코드가 없습니다. 요청을 중단합니다.');
        return;
      }

      const selectedLibraryName = dropdownLibrarySelect.selectedOptions[0].textContent;

      // [변경] 모달 첫 줄 - [책 제목] 선택된 책 제목 형태로 표현
      // modalContent.innerHTML 대체 전에 아래 span에 책 제목 세팅 (span은 HTML에 있어야 함)
      document.getElementById('modalBookTitle').textContent = selectedTitle || '';

      fetch(`/check_library?isbn=${selectedISBN}&libraryCode=${libCode}`)
        .then(res => res.json())
        .then(data => {
          console.log('서버 응답 데이터:', data);
          // [변경] 출력 형식 변경 및 시군구명 추가, '여기' 링크 삽입
          let html = `
            <p><strong>[${selectedLibraryName}]</strong><br>
            소장 여부: <strong>${data.results[0].hasBook ? '소장중' : '미소장'}</strong><br>
            대출 가능 여부: <strong>${data.results[0].loanAvailable ? '가능' : '불가능'}</strong></p>
            <p style="font-size: 13px; color: #777; margin-top: 10px;">
              ※ 대출현황은 조회일 기준, 하루 전 상황이며, 실시간 현황은 해당 도서관에 문의 바랍니다.
            </p>
            
          `;

          modalContent.innerHTML = html;
          modal.style.display = 'block';

        })
        .catch(err => {
          console.error('요청 실패:', err);
          modalContent.innerHTML = `<p style="color:red;">요청 실패: ${err}</p>`;
          modal.style.display = 'block';
        });
    });

    closeDropdownBtn.addEventListener('click', () => {
      dropdownContainer.style.display = 'none';
      dropdownRegionSelect.selectedIndex = 0;
      dropdownDistrictSelect.innerHTML = '<option value="">--시군구 선택--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--도서관 선택--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;
      selectedDistrict = null;  // [추가] 시군구 초기화
    });

    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    window.addEventListener('click', function (e) {
      if (e.target === modal) modal.style.display = 'none';
    });

    function updateLibrarySelect(district) {
      const librarySelect = document.getElementById('librarySelect');
      librarySelect.innerHTML = '<option value="">--도서관 선택--</option>';

      const selectedRegion = dropdownRegionSelect.value.trim();
      const trimmedDistrict = district.trim();  // 혹시 공백 있을까 봐
      const key = `${selectedRegion}|${trimmedDistrict}`;
      console.log('📌 사용 중인 key:', key);
      console.log('📚 전체 keys:', Object.keys(libraryData.librariesByDistrict));

      const libraries = libraryData.librariesByDistrict[key] || [];
      
      libraries.forEach((library) => {
        const option = document.createElement('option');
        option.value = library.libraryCode;
        option.textContent = library.libraryName;
        librarySelect.appendChild(option);
      });

      librarySelect.disabled = libraries.length === 0;
    }
  </script>  
</body>
</html>
