<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë„ì„œ êµ¬ë§¤ì™€ ëŒ€ì—¬ ì •ë³´ë¥¼ í•œëˆˆì—</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 0.5rem;
    }
    #searchInput {
      width: 400px;
      padding: 10px;
      font-size: 16px;
    }
    #searchButton {
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
    }
    .results {
     display: grid;
     grid-template-columns: repeat(4, 300px); /* 4ê°œ, ê³ ì • ë„ˆë¹„ */
     gap: 20px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
     justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
     padding: 20px 0; 
    }
    .book-card {
     width: 300px;  /* ë˜ëŠ” ê¸°ì¡´ ì‚¬ìš©í•˜ë˜ ì •í™•í•œ ë„ˆë¹„ */
     border: 1px solid #ccc;
     border-radius: 6px;
     padding: 6px;
     box-sizing: border-box;
     background: #fff;
    }
    .book-card img {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 6px;
    }
    .book-info {
      margin-top: 6px;
      line-height: 1.3;
    }
    .book-info h3 {
      margin: 3px 0;
      font-size: 15px;
    }
    .price {
      margin-top: 3px;
      font-size: 15px;
      font-weight: bold;
      color: #1a73e8;
    }
    .links a {
      display: inline-block;
      margin-top: 4px;
      color: #555;
      text-decoration: underline;
      font-size: 15px;
      cursor: pointer;
    }
    .dropdown-container {
      position: fixed;
      top: 185px;
      left: 325px;
      z-index: 999;
      display: none;
      flex-wrap: wrap;
      flex-direction: row;
      gap: 10px;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      align-items: center;
      max-width: 95vw;
      box-sizing: border-box;
    }
    
    .dropdown-container select {
      padding: 6px;
      font-size: 14px;
      min-width: 120px;
      flex: 1 1 auto;
      max-width: 100%;
    }
    .dropdown-container #checkLibraryBtn,
    .dropdown-container #closeDropdownBtn {
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
      background-color: #1a73e8;
      border: none;
      color: white;
      border-radius: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .dropdown-container #closeDropdownBtn {
      background-color: orange;
    }

    .dropdown-container #checkLibraryBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #loadMoreBtn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      user-select: none;
    }
    #loadMoreBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    select option {
      color: black !important;
      font-size: 16px;
      opacity: 1 !important;
      background-color: white;
    }
    select:disabled {
      background-color: #f0f0f0;
    }

    /* âœ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;      
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: absolute;
      top: 25%;
      left: 50%;
      transform: translateX(-50%);      
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      box-sizing: border-box;
    }
    .modal-close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover {
      color: black;
    }
    .site-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: clamp(32px, 5vw, 56px);
      max-width: 100%;
      text-align: center;
      margin: 0 auto;
      margin-bottom: 2rem
    }
    .results-wrapper {
      display: flex;
      justify-content: center;
    }
    .shop-link {
      font-size: 30px;  /* ë˜ëŠ” 18px ë“± ì›í•˜ëŠ” í¬ê¸° */
      font-weight: bold; /* ì›í•˜ë©´ ë³¼ë“œë„ ì¶”ê°€ ê°€ëŠ¥ */
      color: #333; /* ìƒ‰ìƒë„ ì›í•˜ëŠ” ëŒ€ë¡œ */
    }
    .api-footer {
      width: 100%;
      background-color: #f0f0f0;
      padding: 5px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      text-align: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .api-footer-content {
      display: flex;
      justify-content: center; /* ê°€ìš´ë° ì •ë ¬ ìœ ì§€ */
      align-items: center;
      padding: 10px 20px;
      font-size: 14px;
      color: #444;
    }
    .api-provide {
      text-align: center;
      flex: 1; /* ì˜ì—­ì„ ë„“ê²Œ ì¡ì•„ ê°€ìš´ë° ì •ë ¬ ìœ ì§€ */
    }

    .api-footer-content span {
      font-weight: 600;
    }
    .footer-contact {
      position: absolute;
      right: 20px;
      font-size: 0.9rem;
      color: #666; /* ì§„í•˜ì§€ ì•Šì€ íšŒìƒ‰ */    }

    .search-hint {
      text-align: center;
      font-size: 14px; /* ì‘ê²Œ */
      color: #888888; /* ì—°í•œ íšŒìƒ‰ */
      margin-top: 4px; /* ê²€ìƒ‰ì°½ê³¼ ì•½ê°„ì˜ ê°„ê²© */
      margin-bottom: 16px; /* ì•„ë˜ ìš”ì†Œì™€ ê°„ê²© */
      padding: 0 10px; /* ì¢Œìš° ì—¬ìœ  â€” ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ ìì—°ìŠ¤ëŸ½ê²Œ */
      line-height: 1.4; /* ì¤„ ê°„ê²© ì‚´ì§ ì—¬ìœ  */
      word-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ í—ˆìš© */
    }
    .spinner {
      border: 8px solid #f3f3f3; /* íšŒìƒ‰ í…Œë‘ë¦¬ */
      border-top: 8px solid #3498db; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    #backToTop {
      display: none; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
      position: fixed;
      bottom: 40px; /* í™”ë©´ ì•„ë˜ìª½ì—ì„œ 40px */
      right: 40px;  /* í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ 40px */
      z-index: 999;
      font-size: 16px;
      border: none;
      outline: none;
      background-color: #1a73e8; /* íŒŒë€ìƒ‰ ë²„íŠ¼ (ì›í•˜ë©´ ë‹¤ë¥¸ ìƒ‰ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ) */
      color: white;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    #backToTop:hover {
      background-color: #0d47a1; /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ìƒ‰ ë³€ê²½ */
    }
    /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    @media (max-width: 768px) {
    .header h1 {
        font-size: 18px;
    }
    .search-box {
        flex-direction: column;
        align-items: stretch;
    }
    .search-box input[type="text"] {
        width: 100%;
    }
    .search-box button {
        width: 100%;
    }
    .book-cover {
        max-width: 80px;
    }
    .book-table th,
    .book-table td {
        font-size: 14px;
        padding: 8px;
    }
    }
    @media (max-width: 480px) {
    .modal-content {
       width: 95%;
       padding: 16px;
       font-size: 14px;
    }
    }
    @media screen and (max-width: 1024px) {
    .results {
    grid-template-columns: repeat(2, 300px); /* íƒœë¸”ë¦¿: 2ê°œ */
    }
    #searchInput {
      height: 36px;       /* ê¸°ë³¸ë³´ë‹¤ ì‘ê²Œ, í•„ìš”í•˜ë©´ ë” ì¡°ì ˆ ê°€ëŠ¥ */
      padding: 6px 10px;
      font-size: 14px;    /* í°íŠ¸ í¬ê¸°ë„ ì‚´ì§ ì¤„ì„ */
      box-sizing: border-box;
    }

    /* ê²€ìƒ‰ ë²„íŠ¼ ë†’ì´ ë§ì¶”ê¸° */
    #searchButton {
      height: 36px;
      font-size: 14px;
      white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
      display: flex;       /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ flex */
      align-items: center; /* ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
      justify-content: center; /* ê°€ë¡œ ê°€ìš´ë° ì •ë ¬ */
      padding: 0 12px;     /* ì¢Œìš° ì—¬ë°± ì ë‹¹íˆ ìœ ì§€ */
    }
    }

    @media screen and (max-width: 600px) {
      .results {
        grid-template-columns: repeat(1, 300px); /* ëª¨ë°”ì¼: 1ê°œ */
    }
    #searchInput {
      height: 36px;       /* ê¸°ë³¸ë³´ë‹¤ ì‘ê²Œ, í•„ìš”í•˜ë©´ ë” ì¡°ì ˆ ê°€ëŠ¥ */
      padding: 6px 10px;
      font-size: 14px;    /* í°íŠ¸ í¬ê¸°ë„ ì‚´ì§ ì¤„ì„ */
      box-sizing: border-box;
    }

    /* ê²€ìƒ‰ ë²„íŠ¼ ë†’ì´ ë§ì¶”ê¸° */
    #searchButton {
      height: 36px;
      font-size: 14px;
      white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
      display: flex;       /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ flex */
      align-items: center; /* ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
      justify-content: center; /* ê°€ë¡œ ê°€ìš´ë° ì •ë ¬ */
      padding: 0 12px;     /* ì¢Œìš° ì—¬ë°± ì ë‹¹íˆ ìœ ì§€ */
    }
    }
    @media (max-width: 768px) {
    .dropdown-container {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: fit-content;
      max-width: calc(100vw - 20px);
      flex-direction: column;
      flex-wrap: wrap;
      justify-content: center;   
      box-sizing: border-box;
      padding: 10px;
    }
    .api-footer-content {
      justify-content: space-between; /* ì¢Œìš° ë ì •ë ¬ */
      position: relative; /* footer-contact ì ˆëŒ€ìœ„ì¹˜ í•´ì œ ìœ„í•´ í•„ìš” */
    }
    .api-provide {
      flex: none;
      text-align: left; /* ì¢Œì¸¡ ì •ë ¬ */
    }
    .footer-contact {
      position: static; /* ì ˆëŒ€ ìœ„ì¹˜ ì—†ì• ì„œ ê²¹ì¹¨ ë°©ì§€ */
      font-size: 0.9rem;
      color: #666;
    }
    }
    @keyframes spin {
     0% { transform: translate(-50%, -50%) rotate(0deg); }
     100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .action-button {
      flex: 1 1 0;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      background-color: #f0f0f0;
      color: #333;
      padding: 6px 8px;
      height: 40px;
      text-decoration: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      transition: background-color 0.3s ease;
      white-space: pre-line;
      box-sizing: border-box;
    }
    .action-button:hover {
      background-color: #e0e0e0;
    }
    @media (max-width: 600px) {
    .button-group {
      flex-direction: row;
      flex-wrap: nowrap;    
    }
    .action-button {
    height: auto;
    }
    }

  </style>
</head>
<body>
  <h1 class="site-title">ğŸ“š ì±…! í•œëˆˆì— </h1>

  <div class="search-container">
    <input id="searchInput" type="text" placeholder="ì±… ì œëª©, ì‘ê°€, ì¶œíŒì‚¬ ì…ë ¥" />
    <button id="searchButton">ê²€ìƒ‰</button>
  </div>
  <div class="search-container">
    <!-- ê¸°ì¡´ ê²€ìƒ‰ì°½ ì½”ë“œ -->
  </div>

  <div class="search-hint">
   ê´€ì‹¬ ë„ì„œì˜ ìƒˆì±… | ì „ìì±… | ì¤‘ê³ ì±… êµ¬ë§¤ì •ë³´ì™€, ê³µê³µë„ì„œê´€ ëŒ€ì—¬ì •ë³´ë¥¼ í•œë²ˆì— í™•ì¸í•©ë‹ˆë‹¤
  </div>

  <div class="results-wrapper">
    <div class="results">
      <!-- ë„ì„œì¹´ë“œë“¤ -->
    </div>
  </div>

  <div id="loadingSpinner" class="spinner" style="display: none;"></div>

  <div class="dropdown-container">
    <select id="regionSelect"><option value="">--ì§€ì—­ ì„ íƒ--</option></select>
    <select id="districtSelect" disabled><option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option></select>
    <select id="librarySelect" disabled><option value="">--ë„ì„œê´€ ì„ íƒ--</option></select>
    <button id="checkLibraryBtn" disabled>í™•ì¸</button>
    <button id="closeDropdownBtn">ë‹«ê¸°</button>
  </div>

  <div class="results" id="results"></div>
  <button id="loadMoreBtn" style="display:none;">ë”ë³´ê¸°</button>

  <!-- âœ… ëª¨ë‹¬ êµ¬ì¡° ì¶”ê°€ -->
  <div id="libraryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="closeModalBtn">&times;</span>
      <div><strong>[ì±… ì œëª©]</strong> <span id="modalBookTitle"></span></div>
      <div id="libraryModalContent">ë¡œë”© ì¤‘...</div>
    </div>
  </div>
  <footer class="api-footer">
  <div class="api-footer-content">
      <div class="api-provide">APIì œê³µ: ì•Œë¼ë”˜ | ë„ì„œê´€ì •ë³´ë‚˜ë£¨</div>
      <div class="footer-contact">jkhong8908@gmail.com</div> 
  </div>
  </footer>
  <button id="backToTop" title="ë§¨ ìœ„ë¡œ ê°€ê¸°">â¬† TOP</button>

<script>
    document.getElementById('searchButton').addEventListener('click', searchBooks);
    document.getElementById('searchInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchBooks();
      }
    });
    const resultsContainer = document.getElementById('results');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const dropdownContainer = document.querySelector('.dropdown-container');
    const dropdownRegionSelect = document.getElementById('regionSelect');
    const dropdownDistrictSelect = document.getElementById('districtSelect');
    const dropdownLibrarySelect = document.getElementById('librarySelect');
    const checkLibraryBtn = document.getElementById('checkLibraryBtn');
    const closeDropdownBtn = document.getElementById('closeDropdownBtn');
    const modal = document.getElementById('libraryModal');
    const modalContent = document.getElementById('libraryModalContent');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let libraryData = {};
    let selectedISBN = null;
    let selectedTitle = null;
    let selectedDistrict = null;  // [ì¶”ê°€] ì‹œêµ°êµ¬ëª… ì €ì¥ìš©
    let allBooks = [];
    let displayedCount = 0;
    const PAGE_SIZE = 12;
    buttonLibrary.innerText = 'ë„ì„œê´€\nëŒ€ì—¬ì •ë³´';

    function formatPrice(num) {
      return Number(num).toLocaleString() + 'ì›';
    }
    function extractItemId(url) {
      const match = url.match(/ItemId=(\d+)/);
      return match ? match[1] : '';
    }
    function isMobile() {
      return /Mobi|Android/i.test(navigator.userAgent);
    }
    function createBookCard(book) {
     const priceNew = book.priceStandard ? formatPrice(book.priceStandard) : 'ì •ë³´ ì—†ìŒ';
     const priceSale = book.priceSales ? formatPrice(book.priceSales) : 'ì •ë³´ ì—†ìŒ';

     const itemId = extractItemId(book.link);

     // ìƒˆì±…/ì „ìì±… ë§í¬
     const newLinkPC = book.link;
     const newLinkMobile = `https://www.aladin.co.kr/m/mproduct.aspx?ItemId=${itemId}`;
     const newLinkFinal = isMobile() ? newLinkMobile : newLinkPC;

     // ì¤‘ê³ ì±… ë§í¬
     const usedLinkPC = `https://www.aladin.co.kr/search/wsearchresult.aspx?SearchTarget=Used&KeyWord=${encodeURIComponent(book.title)}`;
     const usedLinkMobile = `https://www.aladin.co.kr/m/museditemall.aspx?ItemId=${itemId}&TabType=1&Fix=1`;
     const usedLinkFinal = isMobile() ? usedLinkMobile : usedLinkPC;

     const card = document.createElement('div');
     card.className = 'book-card';

     card.innerHTML = `
       <img src="${book.cover}" alt="í‘œì§€ ì´ë¯¸ì§€">
       <div class="book-info">
         <h3>${book.title}</h3>
         <p>ì €ì: ${book.author}</p>
         <p>ì¶œíŒì‚¬: ${book.publisher} (${book.pubDate})</p>
         <p class="price">ì •ê°€: ${priceNew} / í• ì¸ê°€: ${priceSale}</p>
         <div class="button-group">
           <a href="${newLinkFinal}" target="_blank" class="action-button">ìƒˆì±…/ì „ìì±…</a>
           <a href="${usedLinkFinal}" target="_blank" class="action-button">ì¤‘ê³ ì±…</a>
           <button type="button" class="action-button library-status-link"
                data-isbn="${book.isbn13}" 
                data-title="${book.title}">ë„ì„œê´€\nëŒ€ì—¬ì •ë³´</button>
         </div>
       </div>
     `;
     return card;
   }

    function renderBooks() {
      const toShow = allBooks.slice(displayedCount, displayedCount + PAGE_SIZE);
      toShow.forEach(book => {
        resultsContainer.appendChild(createBookCard(book));
      });
      displayedCount += toShow.length;

      if (displayedCount < allBooks.length) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.disabled = false;
      } else {
        loadMoreBtn.style.display = 'none';
      }

      document.querySelectorAll('.library-status-link').forEach(link => {
        link.removeEventListener('click', onLibraryStatusClick);
        link.addEventListener('click', onLibraryStatusClick);
      });
    }

    function onLibraryStatusClick(e) {
      e.preventDefault();
      selectedISBN = e.target.dataset.isbn;
      selectedTitle = e.target.dataset.title;
      console.log('ì„ íƒëœ ISBN:', selectedISBN);
      console.log('ì„ íƒëœ ë„ì„œëª…:', selectedTitle);
      dropdownContainer.style.display = 'flex';
    }

    function searchBooks() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      dropdownContainer.style.display = 'none';
      selectedISBN = null;
      resultsContainer.innerHTML = '';
      loadMoreBtn.style.display = 'none';
      displayedCount = 0;
      allBooks = [];

      document.getElementById('loadingSpinner').style.display = 'block';

    fetch(`/search?query=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.item || data.item.length === 0) {
        resultsContainer.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        allBooks = data.item;
        renderBooks();
      }
    })
    .finally(() => {
      // âœ… API ìš”ì²­ ëë‚¬ìœ¼ë‹ˆ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
      document.getElementById('loadingSpinner').style.display = 'none';
    });
}  

    loadMoreBtn.addEventListener('click', renderBooks);

    fetch('/libraries')
      .then(res => res.json())
      .then(data => {
        libraryData = data;
        data.regions.forEach(region => {
          const opt = document.createElement('option');
          opt.value = region;
          opt.textContent = region;
          dropdownRegionSelect.appendChild(opt);
        });
      });

    dropdownRegionSelect.addEventListener('change', () => {
      const region = dropdownRegionSelect.value;      
      
      dropdownDistrictSelect.innerHTML = '<option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = null;  

      if (!region || !libraryData.districtsByRegion[region]) return;
      
      libraryData.districtsByRegion[region].forEach(district => {
        const opt = document.createElement('option');
        opt.value = district;
        opt.textContent = district;
        dropdownDistrictSelect.appendChild(opt);
      });

      dropdownDistrictSelect.disabled = false;
    });

        
    dropdownDistrictSelect.addEventListener('change', () => {
      const district = dropdownDistrictSelect.value;
      const region = dropdownRegionSelect.value;

      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = district;  // [ì¶”ê°€] ì‹œêµ°êµ¬ ì„ íƒ ì €ì¥

      const key = `${region.trim()}|${district.trim()}`;
      if (!district || !libraryData.librariesByDistrict[key]) return;

      updateLibrarySelect(district);
    });

    dropdownLibrarySelect.addEventListener('change', () => {
      checkLibraryBtn.disabled = !dropdownLibrarySelect.value;
    });

    checkLibraryBtn.addEventListener('click', () => {
      const libCode = dropdownLibrarySelect.value;
      console.log('í™•ì¸ ë²„íŠ¼ í´ë¦­ - ì„ íƒëœ ISBN:', selectedISBN);
      console.log('ì„ íƒëœ ë„ì„œê´€ ì½”ë“œ:', libCode);

      if (!selectedISBN || !libCode) {
        console.log('ISBN ë˜ëŠ” ë„ì„œê´€ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ìš”ì²­ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
        return;
      }

      const selectedLibraryName = dropdownLibrarySelect.selectedOptions[0].textContent;

      // [ë³€ê²½] ëª¨ë‹¬ ì²« ì¤„ - [ì±… ì œëª©] ì„ íƒëœ ì±… ì œëª© í˜•íƒœë¡œ í‘œí˜„
      // modalContent.innerHTML ëŒ€ì²´ ì „ì— ì•„ë˜ spanì— ì±… ì œëª© ì„¸íŒ… (spanì€ HTMLì— ìˆì–´ì•¼ í•¨)
      document.getElementById('modalBookTitle').textContent = selectedTitle || '';
      document.getElementById('loadingSpinner').style.display = 'block';

      fetch(`/check_library?isbn=${selectedISBN}&libraryCode=${libCode}`)
        .then(res => res.json())
        .then(data => {
          console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
          // [ë³€ê²½] ì¶œë ¥ í˜•ì‹ ë³€ê²½ ë° ì‹œêµ°êµ¬ëª… ì¶”ê°€, 'ì—¬ê¸°' ë§í¬ ì‚½ì…
          let html = `
            <p><strong>[${selectedLibraryName}]</strong><br>
            ì†Œì¥ ì—¬ë¶€: <strong>${data.results[0].hasBook ? 'ì†Œì¥ì¤‘' : 'ë¯¸ì†Œì¥'}</strong><br>
            ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€: <strong>${data.results[0].loanAvailable ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥'}</strong></p>
            <p style="font-size: 13px; color: #777; margin-top: 10px;">
              â€» ëŒ€ì¶œí˜„í™©ì€ ì¡°íšŒì¼ ê¸°ì¤€, í•˜ë£¨ ì „ ìƒí™©ì´ë©°, ì‹¤ì‹œê°„ í˜„í™©ì€ í•´ë‹¹ ë„ì„œê´€ì— ë¬¸ì˜ ë°”ëë‹ˆë‹¤.
            </p>
            
          `;

          modalContent.innerHTML = html;
          modal.style.display = 'block';

        })
        .catch(err => {
          console.error('ìš”ì²­ ì‹¤íŒ¨:', err);
          modalContent.innerHTML = `<p style="color:red;">ìš”ì²­ ì‹¤íŒ¨: ${err}</p>`;
          modal.style.display = 'block';
        })
        .finally(() => {
         // âœ… API ìš”ì²­ ëë‚¬ìœ¼ë‹ˆ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
         document.getElementById('loadingSpinner').style.display = 'none';  
        });
    });

    closeDropdownBtn.addEventListener('click', () => {
      dropdownContainer.style.display = 'none';
      dropdownRegionSelect.selectedIndex = 0;
      dropdownDistrictSelect.innerHTML = '<option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;
      selectedDistrict = null;  // [ì¶”ê°€] ì‹œêµ°êµ¬ ì´ˆê¸°í™”
    });

    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    window.addEventListener('click', function (e) {
      if (e.target === modal) modal.style.display = 'none';
    });

    function updateLibrarySelect(district) {
      const librarySelect = document.getElementById('librarySelect');
      librarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';

      const selectedRegion = dropdownRegionSelect.value.trim();
      const trimmedDistrict = district.trim();  // í˜¹ì‹œ ê³µë°± ìˆì„ê¹Œ ë´
      const key = `${selectedRegion}|${trimmedDistrict}`;
      console.log('ğŸ“Œ ì‚¬ìš© ì¤‘ì¸ key:', key);
      console.log('ğŸ“š ì „ì²´ keys:', Object.keys(libraryData.librariesByDistrict));

      const libraries = libraryData.librariesByDistrict[key] || [];
      
      libraries.forEach((library) => {
        const option = document.createElement('option');
        option.value = library.libraryCode;
        option.textContent = library.libraryName;
        librarySelect.appendChild(option);
      });

      librarySelect.disabled = libraries.length === 0;
    }

// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ê°ì§€
  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    const backToTopButton = document.getElementById("backToTop");
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
      backToTopButton.style.display = "block";
    } else {
      backToTopButton.style.display = "none";
    }
  }

  // í´ë¦­ ì‹œ ìƒë‹¨ìœ¼ë¡œ ì´ë™
  document.getElementById("backToTop").addEventListener("click", function() {
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  });
  </script>  


</body>
</html>
