<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë„ì„œ êµ¬ë§¤ì™€ ëŒ€ì—¬ ì •ë³´ë¥¼ í•œëˆˆì—</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    #searchInput {
      width: 400px;
      padding: 10px;
      font-size: 16px;
    }
    #searchButton {
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
    }
    .results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    .book-card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .book-card img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 8px;
    }
    .book-info {
      margin-top: 10px;
    }
    .book-info h3 {
      margin: 5px 0;
    }
    .price {
      margin-top: 5px;
      font-weight: bold;
      color: #1a73e8;
    }
    .links a {
      display: inline-block;
      margin-top: 5px;
      color: #555;
      text-decoration: underline;
      font-size: 14px;
      cursor: pointer;
    }
    .dropdown-container {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      display: none;
      flex-direction: row;
      gap: 10px;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      align-items: center;
    }
    .dropdown-container select {
      padding: 6px;
      font-size: 14px;
      min-width: 150px;
    }
    .dropdown-container #checkLibraryBtn,
    .dropdown-container #closeDropdownBtn {
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
      background-color: #1a73e8;
      border: none;
      color: white;
      border-radius: 4px;
      white-space: nowrap;
    }
    .dropdown-container #checkLibraryBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #loadMoreBtn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      user-select: none;
    }
    #loadMoreBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    select option {
      color: black !important;
      font-size: 16px;
      opacity: 1 !important;
      background-color: white;
    }
    select:disabled {
      background-color: #f0f0f0;
    }

    /* âœ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;      
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: absolute;
      top: 25%;
      left: 20%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover {
      color: black;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š ë„ì„œ êµ¬ë§¤ì™€ ëŒ€ì—¬ ì •ë³´ë¥¼ í•œëˆˆì—</h1>

  <div class="search-container">
    <input id="searchInput" type="text" placeholder="ì±… ì œëª©, ì‘ê°€, ì¶œíŒì‚¬ ì…ë ¥" />
    <button id="searchButton">ê²€ìƒ‰</button>
  </div>

  <div class="dropdown-container">
    <select id="regionSelect"><option value="">--ì§€ì—­ ì„ íƒ--</option></select>
    <select id="districtSelect" disabled><option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option></select>
    <select id="librarySelect" disabled><option value="">--ë„ì„œê´€ ì„ íƒ--</option></select>
    <button id="checkLibraryBtn" disabled>í™•ì¸</button>
    <button id="closeDropdownBtn">ë‹«ê¸°</button>
  </div>

  <div class="results" id="results"></div>
  <button id="loadMoreBtn" style="display:none;">ë”ë³´ê¸°</button>

  <!-- âœ… ëª¨ë‹¬ êµ¬ì¡° ì¶”ê°€ -->
  <div id="libraryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="closeModalBtn">&times;</span>
      <div><strong>[ì±… ì œëª©]</strong> <span id="modalBookTitle"></span></div>
      <div id="libraryModalContent">ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script>
    document.getElementById('searchButton').addEventListener('click', searchBooks);
    document.getElementById('searchInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchBooks();
      }
    });

    const resultsContainer = document.getElementById('results');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const dropdownContainer = document.querySelector('.dropdown-container');
    const dropdownRegionSelect = document.getElementById('regionSelect');
    const dropdownDistrictSelect = document.getElementById('districtSelect');
    const dropdownLibrarySelect = document.getElementById('librarySelect');
    const checkLibraryBtn = document.getElementById('checkLibraryBtn');
    const closeDropdownBtn = document.getElementById('closeDropdownBtn');
    const modal = document.getElementById('libraryModal');
    const modalContent = document.getElementById('libraryModalContent');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let libraryData = {};
    let selectedISBN = null;
    let selectedTitle = null;
    let selectedDistrict = null;  // [ì¶”ê°€] ì‹œêµ°êµ¬ëª… ì €ì¥ìš©
    let allBooks = [];
    let displayedCount = 0;
    const PAGE_SIZE = 12;

    function formatPrice(num) {
      return Number(num).toLocaleString() + 'ì›';
    }

    function createBookCard(book) {
      const priceNew = book.priceStandard ? formatPrice(book.priceStandard) : 'ì •ë³´ ì—†ìŒ';
      const priceSale = book.priceSales ? formatPrice(book.priceSales) : 'ì •ë³´ ì—†ìŒ';
      const usedLink = `https://www.aladin.co.kr/search/wsearchresult.aspx?SearchTarget=Used&KeyWord=${encodeURIComponent(book.title)}`;

      const card = document.createElement('div');
      card.className = 'book-card';

      card.innerHTML = `
        <img src="${book.cover}" alt="í‘œì§€ ì´ë¯¸ì§€">
        <div class="book-info">
          <h3>${book.title}</h3>
          <p>ì €ì: ${book.author}</p>
          <p>ì¶œíŒì‚¬: ${book.publisher} (${book.pubDate})</p>
          <p class="price">ì •ê°€: ${priceNew} / í• ì¸ê°€: ${priceSale}</p>
          <div class="links">
            <a href="${book.link}" target="_blank">ğŸ”— ìƒˆì±…/ ì „ìì±… ì‚¬ëŸ¬ê°€ê¸°</a><br>
            <a href="${usedLink}" target="_blank">ğŸ“š ì¤‘ê³ ì±… ì‚¬ëŸ¬ê°€ê¸°</a><br><br>
            <a href="#" class="library-status-link" 
               data-isbn="${book.isbn13}" 
               data-title="${book.title}"
               style="font-size: 16px; color: #000000; font-weight: bold;">
              ğŸ“– ê´€ì‹¬ë„ì„œê´€ ëŒ€ì—¬í˜„í™© í™•ì¸
            </a>
          </div>
        </div>
      `;
      return card;
    }

    function renderBooks() {
      const toShow = allBooks.slice(displayedCount, displayedCount + PAGE_SIZE);
      toShow.forEach(book => {
        resultsContainer.appendChild(createBookCard(book));
      });
      displayedCount += toShow.length;

      if (displayedCount < allBooks.length) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.disabled = false;
      } else {
        loadMoreBtn.style.display = 'none';
      }

      document.querySelectorAll('.library-status-link').forEach(link => {
        link.removeEventListener('click', onLibraryStatusClick);
        link.addEventListener('click', onLibraryStatusClick);
      });
    }

    function onLibraryStatusClick(e) {
      e.preventDefault();
      selectedISBN = e.target.dataset.isbn;
      selectedTitle = e.target.dataset.title;
      console.log('ì„ íƒëœ ISBN:', selectedISBN);
      console.log('ì„ íƒëœ ë„ì„œëª…:', selectedTitle);
      dropdownContainer.style.display = 'flex';
    }

    function searchBooks() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      dropdownContainer.style.display = 'none';
      selectedISBN = null;
      resultsContainer.innerHTML = '';
      loadMoreBtn.style.display = 'none';
      displayedCount = 0;
      allBooks = [];

      fetch(`/search?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.item || data.item.length === 0) {
            resultsContainer.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          allBooks = data.item;
          renderBooks();
        });
    }

    loadMoreBtn.addEventListener('click', renderBooks);

    fetch('/libraries')
      .then(res => res.json())
      .then(data => {
        libraryData = data;
        data.regions.forEach(region => {
          const opt = document.createElement('option');
          opt.value = region;
          opt.textContent = region;
          dropdownRegionSelect.appendChild(opt);
        });
      });

    dropdownRegionSelect.addEventListener('change', () => {
      const region = dropdownRegionSelect.value;      
      
      dropdownDistrictSelect.innerHTML = '<option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = null;  

      if (!region || !libraryData.districtsByRegion[region]) return;
      
      libraryData.districtsByRegion[region].forEach(district => {
        const opt = document.createElement('option');
        opt.value = district;
        opt.textContent = district;
        dropdownDistrictSelect.appendChild(opt);
      });

      dropdownDistrictSelect.disabled = false;
    });

        
    dropdownDistrictSelect.addEventListener('change', () => {
      const district = dropdownDistrictSelect.value;
      const region = dropdownRegionSelect.value;

      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;

      selectedDistrict = district;  // [ì¶”ê°€] ì‹œêµ°êµ¬ ì„ íƒ ì €ì¥

      const key = `${region.trim()}|${district.trim()}`;
      if (!district || !libraryData.librariesByDistrict[key]) return;

      updateLibrarySelect(district);
    });

    dropdownLibrarySelect.addEventListener('change', () => {
      checkLibraryBtn.disabled = !dropdownLibrarySelect.value;
    });

    checkLibraryBtn.addEventListener('click', () => {
      const libCode = dropdownLibrarySelect.value;
      console.log('í™•ì¸ ë²„íŠ¼ í´ë¦­ - ì„ íƒëœ ISBN:', selectedISBN);
      console.log('ì„ íƒëœ ë„ì„œê´€ ì½”ë“œ:', libCode);

      if (!selectedISBN || !libCode) {
        console.log('ISBN ë˜ëŠ” ë„ì„œê´€ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ìš”ì²­ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
        return;
      }

      const selectedLibraryName = dropdownLibrarySelect.selectedOptions[0].textContent;

      // [ë³€ê²½] ëª¨ë‹¬ ì²« ì¤„ - [ì±… ì œëª©] ì„ íƒëœ ì±… ì œëª© í˜•íƒœë¡œ í‘œí˜„
      // modalContent.innerHTML ëŒ€ì²´ ì „ì— ì•„ë˜ spanì— ì±… ì œëª© ì„¸íŒ… (spanì€ HTMLì— ìˆì–´ì•¼ í•¨)
      document.getElementById('modalBookTitle').textContent = selectedTitle || '';

      fetch(`/check_library?isbn=${selectedISBN}&libraryCode=${libCode}`)
        .then(res => res.json())
        .then(data => {
          console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
          // [ë³€ê²½] ì¶œë ¥ í˜•ì‹ ë³€ê²½ ë° ì‹œêµ°êµ¬ëª… ì¶”ê°€, 'ì—¬ê¸°' ë§í¬ ì‚½ì…
          let html = `
            <p><strong>[${selectedLibraryName}]</strong><br>
            ì†Œì¥ ì—¬ë¶€: <strong>${data.results[0].hasBook ? 'ì†Œì¥ì¤‘' : 'ë¯¸ì†Œì¥'}</strong><br>
            ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€: <strong>${data.results[0].loanAvailable ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥'}</strong></p>
            <p style="font-size: 13px; color: #777; margin-top: 10px;">
              â€» ëŒ€ì¶œí˜„í™©ì€ ì¡°íšŒì¼ ê¸°ì¤€, í•˜ë£¨ ì „ ìƒí™©ì´ë©°, ì‹¤ì‹œê°„ í˜„í™©ì€ í•´ë‹¹ ë„ì„œê´€ì— ë¬¸ì˜ ë°”ëë‹ˆë‹¤.
            </p>
            
          `;

          modalContent.innerHTML = html;
          modal.style.display = 'block';

        })
        .catch(err => {
          console.error('ìš”ì²­ ì‹¤íŒ¨:', err);
          modalContent.innerHTML = `<p style="color:red;">ìš”ì²­ ì‹¤íŒ¨: ${err}</p>`;
          modal.style.display = 'block';
        });
    });

    closeDropdownBtn.addEventListener('click', () => {
      dropdownContainer.style.display = 'none';
      dropdownRegionSelect.selectedIndex = 0;
      dropdownDistrictSelect.innerHTML = '<option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option>';
      dropdownLibrarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';
      dropdownDistrictSelect.disabled = true;
      dropdownLibrarySelect.disabled = true;
      checkLibraryBtn.disabled = true;
      selectedDistrict = null;  // [ì¶”ê°€] ì‹œêµ°êµ¬ ì´ˆê¸°í™”
    });

    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    window.addEventListener('click', function (e) {
      if (e.target === modal) modal.style.display = 'none';
    });

    function updateLibrarySelect(district) {
      const librarySelect = document.getElementById('librarySelect');
      librarySelect.innerHTML = '<option value="">--ë„ì„œê´€ ì„ íƒ--</option>';

      const selectedRegion = dropdownRegionSelect.value.trim();
      const trimmedDistrict = district.trim();  // í˜¹ì‹œ ê³µë°± ìˆì„ê¹Œ ë´
      const key = `${selectedRegion}|${trimmedDistrict}`;
      console.log('ğŸ“Œ ì‚¬ìš© ì¤‘ì¸ key:', key);
      console.log('ğŸ“š ì „ì²´ keys:', Object.keys(libraryData.librariesByDistrict));

      const libraries = libraryData.librariesByDistrict[key] || [];
      
      libraries.forEach((library) => {
        const option = document.createElement('option');
        option.value = library.libraryCode;
        option.textContent = library.libraryName;
        librarySelect.appendChild(option);
      });

      librarySelect.disabled = libraries.length === 0;
    }
  </script>  
</body>
</html>
