<!DOCTYPE html>
<html lang="ko">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZLTTC3JYS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FZLTTC3JYS');
  </script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\
  })(window,document,'script','dataLayer','GTM-KCW6JKPC');</script>
  <script type="text/javascript" src="//wcs.naver.net/wcslog.js"></script>
  <script type="text/javascript">
  if(!wcs_add) var wcs_add = {};
  wcs_add["wa"] = "12e16a2578e9ca0";
  if(window.wcs) {
    wcs_do();
  }
  </script>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="naver-site-verification" content="45e275fbf1e3c48aa11dae5203830034f4fe02db" />
  <meta name="description" content="ê´€ì‹¬ë„ì„œì— ëŒ€í•œ êµ¬ë§¤ ì •ë³´ì™€, ë„ì„œê´€ ëŒ€ì—¬ ì •ë³´ê¹Œì§€ í•œ ê³³ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤">
  <title>CheckChaek - ìƒˆì±…ê³¼ ì¤‘ê³ ì±…, ë„ì„œê´€ ëŒ€ì¶œì •ë³´ê¹Œì§€</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='book.png') }}">
  <style>
    body {
      background-color: #f8f9fa; 
      font-family: sans-serif;
      padding-bottom: 70px; /* footer ë†’ì´ë§Œí¼ íŒ¨ë”© ì¶”ê°€ */
    }
    header {
      text-align: center;
      margin: 20px 0;
    }
    .search-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
    }
    #searchInput {
      width: 70%;
      max-width: 500px;
      padding: 10px;
    }
    #searchInput::placeholder {
      font-size: 15px; /* ê¸€ì í¬ê¸°ë¥¼ ì‘ê²Œ */
      color: #aaaaaa; /* ê¸€ì ìƒ‰ì„ í¬ë¯¸í•˜ê²Œ (ì—°í•œ íšŒìƒ‰) */
      opacity: 1; /* ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€ */
    }
    .results {
      display: grid;
      grid-template-columns: repeat(4, 300px);
      gap: 20px;
      justify-content: center;
      padding: 20px 0;
    }
    .results-wrapper {
      display: flex;
      justify-content: center;
    }
    .book-card {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      width: 300px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .book-card img {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .book-info {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .book-info strong {
        font-size: 15px;
        line-height: 1.4;
    }
    .price {
      font-size: 13px;
      color: #666;
      margin-top: 3px;
    }
    
    /* 4ê°œ ë²„íŠ¼ ê·¸ë£¹ UI ë° ë°˜ì‘í˜• */
    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 5px; 
      margin-top: auto;
      padding-top: 10px;
      flex-wrap: wrap; 
    }
    
    /* ğŸ¨ ëª¨ë“  ë²„íŠ¼ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (í°ìƒ‰ ë°°ê²½, í…Œë‘ë¦¬ ì¶”ê°€) */
    .action-button {
      flex: 1 1 48%; /* PC/íƒœë¸”ë¦¿ ê¸°ë³¸ê°’: 2ê°œì”© ë°°ì¹˜ */
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 8px 0; 
      text-decoration: none;
      border-radius: 4px;
      font-weight: bold;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease; /* ì „í™˜ íš¨ê³¼ë¥¼ ìœ„í•´ allë¡œ ë³€ê²½ */
      background-color: #ffffff; 
      border: 1px solid; 
      white-space: nowrap;
    }
    
    /* ğŸ¨ ê°œë³„ ë²„íŠ¼ ê¸€ììƒ‰ ë° í…Œë‘ë¦¬ ìƒ‰ìƒ ì„¤ì • */
    .btn-new-ebook { 
      color: #3f51b5; /* íŒŒë‘ ê³„ì—´ ê¸€ììƒ‰ */
      border-color: #3f51b5;
    } 
    .btn-used { 
      color: #e8a01a; /* ì£¼í™© ê³„ì—´ ê¸€ììƒ‰ */
      border-color: #e8a01a;
    } 
    .btn-lib-select { 
      color: #4caf50; /* ë…¹ìƒ‰ ê³„ì—´ ê¸€ììƒ‰ */
      border-color: #4caf50;
    } 
    .btn-lib-region { 
      color: #2196f3; /* í•˜ëŠ˜ìƒ‰ ê³„ì—´ ê¸€ììƒ‰ */
      border-color: #2196f3;
    } 

    /* ğŸ¨ í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰/ê¸€ììƒ‰ ë°˜ì „ íš¨ê³¼ */
    .btn-new-ebook:hover { 
      background-color: #3f51b5; 
      color: #ffffff; 
    } 
    .btn-used:hover { 
      background-color: #e8a01a; 
      color: #ffffff; 
    } 
    .btn-lib-select:hover { 
      background-color: #4caf50; 
      color: #ffffff; 
    } 
    .btn-lib-region:hover { 
      background-color: #2196f3; 
      color: #ffffff; 
    }

    /* ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
    .region-select {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal-body { 
      max-height: 400px;
      overflow-y: auto;
    }
    .text-success-custom {
    color: #28a745 !important; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© success ìƒ‰ìƒ (ì´ˆë¡ìƒ‰) */
    font-weight: bold; /* ì„ íƒì ìœ¼ë¡œ êµµì€ ê¸€ê¼´ ì¶”ê°€ */
    }

    /* ë¶€ê°€ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .spinner { 
      border: 8px solid #f3f3f3; 
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    #loadMoreBtn { /* ë”ë³´ê¸° ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
      margin: 20px auto 100px; 
    }
    #backToTop { 
      display: none; 
      position: fixed;
      bottom: 50px; 
      right: 20px;
      z-index: 999;
      font-size: 16px;
      border: none;
      outline: none;
      background-color: #e8a01a;
      color: white;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .api-footer { 
      width: 100%;
      background-color: #f0f0f0;
      padding: 1px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      text-align: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .api-footer-content { 
      display: flex;
      justify-content: space-between; 
      align-items: center;
      padding: 4px 20px;
      font-size: 12px;
      color: #444;
    }
    .site-title { 
      font-size: clamp(32px, 5vw, 56px);
      max-width: 100%;
      text-align: center;
      margin: 0 auto 2rem;
    }
    #shareButton { 
      display: none;
    }
    
    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    @media (max-width: 1024px) {
      .results {
        grid-template-columns: repeat(2, 300px);
      }
      #searchInput {
        width: 75%;
      }
      #searchInput::placeholder {
        font-size: 13px; /* ëª¨ë°”ì¼ì—ì„œ ë” ì‘ì€ ê¸€ì í¬ê¸° */
        /* color: #cccccc; <- í•„ìš”í•˜ë©´ ë” í¬ë¯¸í•œ ìƒ‰ìƒì„ ì¬ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. */
      }
      #shareButton { 
        display: inline-block;
      }
      .api-footer-content {
        flex-direction: column;
        align-items: center;
        padding: 4px 10px;
      }
      /* â­â­â­ ìš”ì²­ ì‚¬í•­ ë°˜ì˜: ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ì„ 2x2 ë°°ì—´ë¡œ ì„¤ì • â­â­â­ */
      .action-button {
        flex: 1 1 48%; /* í•œ ì¤„ì— 2ê°œì”© ë°°ì¹˜ë˜ë„ë¡ 48%ë¡œ ìœ ì§€ */
        font-size: 14px;
        padding: 10px 0;
      }
      .button-group {
          gap: 10px;
      }
    }
    @media (max-width: 600px) {
      .results {
        grid-template-columns: repeat(1, 300px);
      }
    }
  </style>
</head>
<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KCW6JKPC"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <header>
    <h1 class="site-title">ğŸ“šì±…! í•œëˆˆì—      
    </h1>
  </header>

  <div class="search-bar">
    <input type="text" id="searchInput" class="form-control" placeholder="ì±…ì œëª©, ì €ì, ì¶œíŒì‚¬ ìµœì†Œ í•˜ë‚˜ ì´ìƒ ì…ë ¥">
    <button id="searchBtn" class="btn btn-primary ms-2">ê²€ìƒ‰</button>
  </div>
  
  <div class="search-hint" style="text-align: center; font-size: 14px; color: #888888; margin-bottom: 16px; padding: 0 25px">
    ê´€ì‹¬ ë„ì„œì˜ ìƒˆì±… | ì „ìì±… | ì¤‘ê³ ì±… êµ¬ë§¤ì •ë³´ì™€, ê³µê³µë„ì„œê´€ ëŒ€ì—¬ì •ë³´ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.
  </div>

  <div class="results-wrapper">
    <div class="results" id="results">
      </div>
  </div>

  <div id="loadingSpinner" class="spinner" style="display: none;"></div>
  
  <button id="loadMoreBtn" class="btn btn-secondary" style="display:none; margin: 20px auto 100px;">ë”ë³´ê¸°</button>  

  <div class="modal fade" id="libraryModal" tabindex="-1" aria-labelledby="libraryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="libraryModalLabel">ëŒ€ì—¬ì •ë³´(ë„ì„œê´€ë³„): <span id="modalLibBookTitle"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-2">
            ğŸ“˜ ëŒ€ì¶œí˜„í™©ì€ ì¡°íšŒì¼ ê¸°ì¤€ í•˜ë£¨ ì „ ìƒí™©ìœ¼ë¡œ, ì‹¤ì‹œê°„ í˜„í™©ì€ í•´ë‹¹ ë„ì„œê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
          </p>
          <div class="region-select">
            <select id="regionSelect1" class="form-select"><option value="">--ì§€ì—­ ì„ íƒ--</option></select>
            <select id="districtSelect1" class="form-select" disabled><option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option></select>
          </div>
          <select id="librarySelect" class="form-select mb-3" disabled><option value="">--ë„ì„œê´€ ì„ íƒ--</option></select>
          <button id="checkLibraryBtn" class="btn btn-success mb-3">ê²€ìƒ‰</button>
          <div id="libraryResult"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="regionModal" tabindex="-1" aria-labelledby="regionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="regionModalLabel">ëŒ€ì—¬ì •ë³´(ì§€ì—­ë³„): <span id="modalRegionBookTitle"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-2">
            ğŸ“˜ ëŒ€ì¶œí˜„í™©ì€ ì¡°íšŒì¼ ê¸°ì¤€ í•˜ë£¨ ì „ ìƒí™©ìœ¼ë¡œ, ì‹¤ì‹œê°„ í˜„í™©ì€ í•´ë‹¹ ë„ì„œê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
          </p>
          <div class="region-select">
            <select id="regionSelect2" class="form-select"><option value="">--ì§€ì—­ ì„ íƒ--</option></select>
            <select id="districtSelect2" class="form-select" disabled><option value="">--ì‹œêµ°êµ¬ ì„ íƒ--</option></select>
          </div>
          <button id="checkRegionBtn" class="btn btn-success mb-3">ê²€ìƒ‰</button>
          <div id="regionResult"></div>
        </div>
      </div>
    </div>
  </div>

<footer class="api-footer">
  <div class="api-footer-content">
      <div class="api-provide">APIì œê³µ: ì•Œë¼ë”˜ | ë„ì„œê´€ì •ë³´ë‚˜ë£¨</div>
    <div class="footer-contact">checkchaek.kr@gmail.com</div> 
  </div>
</footer>
<button id="backToTop" title="ë§¨ ìœ„ë¡œ ê°€ê¸°">â¬† TOP</button>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===================================================================
// ë³€ìˆ˜ ì„¤ì • ë° ì´ˆê¸°í™”
// ===================================================================
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const resultsDiv = document.getElementById("results");
const loadMoreBtn = document.getElementById('loadMoreBtn');
const loadingSpinner = document.getElementById('loadingSpinner');

// 1. ë„ì„œê´€ë³„ ëª¨ë‹¬ ë³€ìˆ˜ (index-1.txt ë³µì›)
const libraryModalElement = document.getElementById("libraryModal");
const libraryModal = new bootstrap.Modal(libraryModalElement);
const regionSelect1 = document.getElementById("regionSelect1");
const districtSelect1 = document.getElementById("districtSelect1");
const librarySelect = document.getElementById("librarySelect");
const checkLibraryBtn = document.getElementById("checkLibraryBtn");
const libraryResultDiv = document.getElementById("libraryResult");

// 2. ì§€ì—­ë³„ ëª¨ë‹¬ ë³€ìˆ˜ (index-2.txt ìœ ì§€)
const regionModalElement = document.getElementById("regionModal");
const regionModal = new bootstrap.Modal(regionModalElement);
const regionSelect2 = document.getElementById("regionSelect2");
const districtSelect2 = document.getElementById("districtSelect2");
const checkRegionBtn = document.getElementById("checkRegionBtn");
const regionResultDiv = document.getElementById("regionResult");


let allLibraryData = null; 
let selectedBook = null; 
let allBooks = []; 
let displayedCount = 0; 
const PAGE_SIZE = 12; 

// ===================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (index-1.txt ìœ ì§€)
// ===================================================================
function formatPrice(num) {
  return Number(num).toLocaleString() + 'ì›';
}
function extractItemId(url) {
  const match = url.match(/ItemId=(\d+)/);
  return match ? match[1] : '';
}
function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);
}

// ===================================================================
// 1ï¸âƒ£ ë„ì„œ ì¹´ë“œ ìƒì„± (4ê°œ ë²„íŠ¼ UI ë° ë°˜ì‘í˜• ì ìš©)
// ===================================================================
function createBookCard(book) { 
  const priceNew = book.priceStandard ? formatPrice(book.priceStandard) : 'ì •ë³´ ì—†ìŒ';
  const priceSale = book.priceSales ? formatPrice(book.priceSales) : 'ì •ë³´ ì—†ìŒ';
  const itemId = extractItemId(book.link);
  
  const newLinkFinal = isMobile() ? `https://www.aladin.co.kr/m/mproduct.aspx?ItemId=${itemId}` : book.link;
  const usedLinkFinal = isMobile() ? `https://www.aladin.co.kr/m/museditemall.aspx?ItemId=${itemId}&TabType=1&Fix=1` 
                                  : `https://www.aladin.co.kr/search/wsearchresult.aspx?SearchTarget=Used&KeyWord=${encodeURIComponent(book.title)}`;

  const card = document.createElement('div');
  card.className = 'book-card';

  card.innerHTML = `
    <img src="${book.cover}" alt="í‘œì§€ ì´ë¯¸ì§€">
    <div class="book-info mt-2">
      <strong>${book.title}</strong><br>
      ${book.author}<br>
      ${book.publisher} (${book.pubDate})
      <p class="price">ì •ê°€: ${priceNew} / í• ì¸ê°€: ${priceSale}</p>
      
      <div class="button-group">
        <a href="${newLinkFinal}" target="_blank" class="action-button btn-new-ebook">ìƒˆì±…/ì „ìì±…</a>
        
        <a href="${usedLinkFinal}" target="_blank" class="action-button btn-used">ì¤‘ê³ ì±…</a>
        
        <button type="button" class="action-button btn-lib-select"
                data-isbn="${book.isbn13}" 
                data-title="${book.title.replace(/'/g, "\\'")}"
                onclick="openLibraryModal('${book.isbn13}','${book.title.replace(/'/g, "\\'")}')">
          ëŒ€ì—¬ì •ë³´<br>(ë„ì„œê´€ë³„)
        </button>
        
        <button type="button" class="action-button btn-lib-region"
                data-isbn="${book.isbn13}" 
                data-title="${book.title.replace(/'/g, "\\'")}"
                onclick="openRegionModal('${book.isbn13}','${book.title.replace(/'/g, "\\'")}')">
          ëŒ€ì—¬ì •ë³´<br>(ì§€ì—­ë³„)
        </button>
      </div>
    </div>
  `;
  return card;
}

// ===================================================================
// 2ï¸âƒ£ ë„ì„œ ê²€ìƒ‰, í˜ì´ì§• (index-1.txt ë¡œì§ ìœ ì§€ + 'ë”ë³´ê¸°' ê°€ì‹œì„± ìˆ˜ì •)
// ===================================================================
searchBtn.addEventListener("click", searchBooks);
searchInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") searchBooks();
});
loadMoreBtn.addEventListener('click', renderBooks);

function renderBooks() {
  const toShow = allBooks.slice(displayedCount, displayedCount + PAGE_SIZE);
  toShow.forEach(book => {
    resultsDiv.appendChild(createBookCard(book));
  });
  displayedCount += toShow.length;

  // 'ë”ë³´ê¸°' ë²„íŠ¼ ê°€ì‹œì„± ë¡œì§ (ë” ë³¼ ì±…ì´ ìˆì„ ë•Œë§Œ ë³´ì´ë„ë¡)
  if (displayedCount < allBooks.length) {
    loadMoreBtn.style.display = 'block';
    loadMoreBtn.disabled = false;
  } else {
    loadMoreBtn.style.display = 'none';
  }
}

function searchBooks() {
  const query = searchInput.value.trim();
  if (!query) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

  resultsDiv.innerHTML = '';
  loadMoreBtn.style.display = 'none'; // ê²€ìƒ‰ ì‹œì‘ ì‹œ ìˆ¨ê¹€
  displayedCount = 0;
  allBooks = [];
  loadingSpinner.style.display = 'block';

  fetch(`/search?query=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.item || data.item.length === 0) { 
        resultsDiv.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        allBooks = data.item;
        renderBooks();
      }
    })
    .catch((err) => {
      console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", err);
      resultsDiv.innerHTML = '<p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    })
    .finally(() => {
      loadingSpinner.style.display = 'none';
    });
}


// ===================================================================
// 3ï¸âƒ£ ë„ì„œê´€ ë°ì´í„° ë¡œë“œ (ë‘ ëª¨ë‹¬ ê³µí†µ ì‚¬ìš©)
// ===================================================================
function loadLibraries() {
  if (allLibraryData) return Promise.resolve(allLibraryData);
  loadingSpinner.style.display = 'block';
  return fetch("/libraries")
    .then((res) => res.json())
    .then((data) => {
      allLibraryData = data;
      // ì§€ì—­ ëª©ë¡ ì±„ìš°ê¸° (ë‘ ëª¨ë‹¬ì˜ Selectì— ëª¨ë‘ ì‚¬ìš©)
      const regionsHtml = `<option value="">--ì§€ì—­ ì„ íƒ--</option>` + 
                          data.regions.map(r => `<option value="${r}">${r}</option>`).join('');
      regionSelect1.innerHTML = regionsHtml;
      regionSelect2.innerHTML = regionsHtml;
      return data;
    })
    .finally(() => {
        loadingSpinner.style.display = 'none';
    });
}
loadLibraries();


// ===================================================================
// 4ï¸âƒ£ 'ë„ì„œê´€ë³„' ëª¨ë‹¬ ë¡œì§ (index-1.txt ê¸°ëŠ¥ ë³µì› ë° í†µí•©)
// ===================================================================
function openLibraryModal(isbn, title) {
  selectedBook = { isbn, title };
  document.getElementById('modalLibBookTitle').textContent = title; 
  libraryResultDiv.innerHTML = ""; 
  
  // ëª¨ë‹¬ ì—´ ë•Œ ì„ íƒì°½ ì´ˆê¸°í™”
  regionSelect1.selectedIndex = 0;
  districtSelect1.innerHTML = "<option value=''>--ì‹œêµ°êµ¬ ì„ íƒ--</option>";
  districtSelect1.disabled = true;
  librarySelect.innerHTML = "<option value=''>--ë„ì„œê´€ ì„ íƒ--</option>";
  librarySelect.disabled = true;

  libraryModal.show();
}

// ë„ì„œê´€ë³„: ì‹œ/êµ°/êµ¬ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (index-1.txt ë¡œì§ ê¸°ë°˜)
regionSelect1.addEventListener("change", () => {
  const region = regionSelect1.value;
  districtSelect1.innerHTML = "<option value=''>--ì‹œêµ°êµ¬ ì„ íƒ--</option>";
  districtSelect1.disabled = true;
  librarySelect.innerHTML = "<option value=''>--ë„ì„œê´€ ì„ íƒ--</option>";
  librarySelect.disabled = true;

  if (!region || !allLibraryData.districtsByRegion[region]) return;
  
  allLibraryData.districtsByRegion[region].forEach((d) => {
    districtSelect1.innerHTML += `<option value="${d}">${d}</option>`;
  });
  districtSelect1.disabled = false;
});

// ë„ì„œê´€ë³„: ë„ì„œê´€ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (index-1.txt ë¡œì§ ê¸°ë°˜)
districtSelect1.addEventListener("change", () => {
  const region = regionSelect1.value;
  const district = districtSelect1.value;
  librarySelect.innerHTML = "<option value=''>--ë„ì„œê´€ ì„ íƒ--</option>";
  librarySelect.disabled = true;

  if (!region || !district) return;

  const key = `${region}|${district}`;
  const libraries = allLibraryData.librariesByDistrict[key] || [];
  
  libraries.forEach((library) => {
    const option = document.createElement('option');
    option.value = library.libraryCode;
    option.textContent = library.libraryName;
    librarySelect.appendChild(option);
  });
  librarySelect.disabled = libraries.length === 0;
});

// ë„ì„œê´€ë³„: ë„ì„œê´€ ê²€ìƒ‰ ë²„íŠ¼ (index-1.txt ë¡œì§ ê¸°ë°˜)
checkLibraryBtn.addEventListener("click", () => {
  const libraryCode = librarySelect.value;
  if (!libraryCode || !selectedBook) return alert("ë„ì„œê´€ê³¼ ë„ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  loadingSpinner.style.display = 'block';
  libraryResultDiv.innerHTML = "ì¡°íšŒ ì¤‘...";

  fetch(`/check_library?isbn=${selectedBook.isbn}&libraryCode=${libraryCode}`)
    .then((res) => res.json())
    .then((data) => {
      // ê²°ê³¼ HTML ìƒì„± (index-1.txt ìŠ¤íƒ€ì¼)
      let html = "";
      if (data.results && data.results.length > 0) {
          const r = data.results[0];

          const hasBookText = r.hasBook ? `<span class="text-success-custom">ì†Œì¥ì¤‘</span>` : "ë¯¸ì†Œì¥";
          const loanAvailableText = r.loanAvailable ? `<span class="text-success-custom">ê°€ëŠ¥</span>` : "ë¶ˆê°€ëŠ¥";



          html = `
            <table class="table table-bordered table-sm mt-3">
              <tbody>
                <tr><th>ë„ì„œê´€</th><td>${r.libraryName}</td></tr>

                <tr><th>ì†Œì¥ ì—¬ë¶€</th><td>${hasBookText}</td></tr>
                <tr><th>ëŒ€ì¶œ ê°€ëŠ¥</th><td>${loanAvailableText}</td></tr>

                <tr><th>ì†Œì¥ ì—¬ë¶€</th><td>${r.hasBook ? "ì†Œì¥ì¤‘" : "ë¯¸ì†Œì¥"}</td></tr>
                <tr><th>ëŒ€ì¶œ ê°€ëŠ¥</th><td>${r.loanAvailable ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"}</td></tr>

              </tbody>
            </table>
          `;
      } else {
          html = `<p class="text-danger mt-3">ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
      libraryResultDiv.innerHTML = html;
    })
    .catch((err) => {
      console.error("ë„ì„œê´€ë³„ ê²€ìƒ‰ ì˜¤ë¥˜:", err);
      libraryResultDiv.innerHTML = "ì˜¤ë¥˜ ë°œìƒ";
    })
    .finally(() => {
      loadingSpinner.style.display = 'none';
    });
});


// ===================================================================
// 5ï¸âƒ£ 'ì§€ì—­ë³„' ëª¨ë‹¬ ë¡œì§ (index-2.txt ë¡œì§ ìœ ì§€)
// ===================================================================
function openRegionModal(isbn, title) {
  selectedBook = { isbn, title };
  document.getElementById('modalRegionBookTitle').textContent = title; // ì±… ì œëª© í‘œì‹œ
  regionResultDiv.innerHTML = ""; // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
  
  // ëª¨ë‹¬ ì—´ ë•Œ ì§€ì—­ ì„ íƒ ì´ˆê¸°í™”
  regionSelect2.selectedIndex = 0;
  districtSelect2.innerHTML = "<option value=''>--ì‹œêµ°êµ¬ ì„ íƒ--</option>";
  districtSelect2.disabled = true;

  regionModal.show();
}

// ì§€ì—­ë³„: ì‹œ/êµ°/êµ¬ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (index-2.txt ë¡œì§)
regionSelect2.addEventListener("change", () => {
  const region = regionSelect2.value;
  districtSelect2.innerHTML = "<option value=''>--ì‹œêµ°êµ¬ ì„ íƒ--</option>";
  districtSelect2.disabled = true;

  if (!region || !allLibraryData.districtsByRegion[region]) return;
  
  allLibraryData.districtsByRegion[region].forEach((d) => {
    districtSelect2.innerHTML += `<option value="${d}">${d}</option>`;
  });
  districtSelect2.disabled = false;
});

// ì§€ì—­ë³„: ë„ì„œê´€ ê²€ìƒ‰ ë²„íŠ¼ (index-2.txt ë¡œì§)
checkRegionBtn.addEventListener("click", () => {
  const region = regionSelect2.value;
  const district = districtSelect2.value;
  if (!region || !district || !selectedBook) return alert("ì§€ì—­ê³¼ ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  loadingSpinner.style.display = 'block';
  regionResultDiv.innerHTML = "ì¡°íšŒ ì¤‘...";

  fetch(`/check_region?isbn=${selectedBook.isbn}&region=${region}&district=${district}`)
    .then((res) => res.json())
    .then((data) => {
      if (!data.results || data.results.length === 0) {
        regionResultDiv.innerHTML = "í•´ë‹¹ ì§€ì—­ì˜ ë„ì„œê´€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // í…Œì´ë¸” ê²°ê³¼ ìƒì„± (index-2.txt ìŠ¤íƒ€ì¼)
      let html = `
        <table class="table table-bordered table-striped mt-3">
          <thead>
            <tr>
              <th>ë„ì„œê´€ëª…</th>
              <th>ì†Œì¥ì—¬ë¶€</th>
              <th>ëŒ€ì¶œê°€ëŠ¥</th>
            </tr>
          </thead>
            <tbody>

            ${data.results.map(r => {
                  // 'ì†Œì¥ì¤‘' ë˜ëŠ” 'ê°€ëŠ¥'ì¼ ë•Œ ì´ˆë¡ìƒ‰ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ëŠ” ë³€ìˆ˜
                const hasBookText = r.hasBook ? `<span class="text-success-custom">ì†Œì¥ì¤‘</span>` : "ë¯¸ì†Œì¥";
                const loanAvailableText = r.loanAvailable ? `<span class="text-success-custom">ê°€ëŠ¥</span>` : "ë¶ˆê°€ëŠ¥";
                
                return `
              <tr>
                <td>${r.libraryName}</td>
                <td>${hasBookText}</td>
                <td>${loanAvailableText}</td>
              </tr>`
            }).join("")}


            ${data.results.map(r => `
              <tr>
                <td>${r.libraryName}</td>
                <td>${r.hasBook ? "ì†Œì¥ì¤‘" : "ë¯¸ì†Œì¥"}</td>
                <td>${r.loanAvailable ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"}</td>
              </tr>`).join("")}

          </tbody>
        </table>
      `;
      regionResultDiv.innerHTML = html;
    })
    .catch((err) => {
      console.error("ì§€ì—­ë³„ ê²€ìƒ‰ ì˜¤ë¥˜:", err);
      regionResultDiv.innerHTML = "ì˜¤ë¥˜ ë°œìƒ";
    })
    .finally(() => {
      loadingSpinner.style.display = 'none';
    });
});


// ===================================================================
// 6ï¸âƒ£ ë¶€ê°€ ê¸°ëŠ¥ (index-1.txt ë¡œì§ ìœ ì§€)
// ===================================================================
window.onscroll = function() {scrollFunction()};
function scrollFunction() {
  const backToTopButton = document.getElementById("backToTop");
  if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
    backToTopButton.style.display = "block";
  } else {
    backToTopButton.style.display = "none";
  }
}
document.getElementById("backToTop").addEventListener("click", function() {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
});

</script>
</body>
</html>